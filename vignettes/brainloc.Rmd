---
title: "brainloc"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{brainloc}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

## About brainloc

The brainloc package serves to describe a location on a brain surface mesh that is in MNI305 space, like the surfaces of the fsaverage standard brain templates used by FreeSurfer. Typical use cases of this package in the field of computational neuroimaging include:

* Finding the mesh vertex closest to a given coordinate (using Euclidean distance).
* Finding the coordinates of a vertex on in various standard coordinate systems (MNI305, MNI152 and Talairach).
* Finding the brain region the vertex lies in (according to any brain atlas available for the respective surface, like the Desikan atlas).
* Finding the distances of all atlas regions to the given vertex (using Euclidean or geodesic distance).

Statistical results are often presented as significant clusters of activation on a brain surface mesh (sets of connected vertices). Typical use cases for working with clusters are:

* Finding the extreme value of a cluster (min, max, or absolute max) and the vertex at which it occurs.
* Finding the peaks within a cluster.
* Finding the brain regions that overlap with the cluster (including the degree of overlap).

This vignette describes how to perform these tasks with the brainloc package.

## Usage Examples

### Preparation: Getting the data required to run the examples

You will need a directory with the brain templates you want to use, typically these are the fsaverage subjects that come with the FreeSurfer neuroimaging software suite. When FreeSurfer is installed and configured properly on your system, the environment variable `SUBJECTS_DIR` points at the `subjects` directory under the installation directory (`FREESURFER_HOME`), and it will be used to find the templates. You can also set `SUBJECTS_DIR` to your custom template directory, of course.

If you cannot or do not want to set environment variables, you can set the option `brainloc.subjects_dir` in R to any directory that contains the expected directory structure like this: `options("brainloc.subjects_dir"="~/my_fs_home/subjects/")`. This would mean that `~/my_fs_home/subjects/` exists on your system and holds the directories of the template subjects. We assume that you have the `fsaverage` subject in there. Setting this option takes precedence over any environment variables.


### Creating a brainparc object

Let's say we have a coordinate in MNI305 surface space and want to find the closest vertex. We first load `brainloc` and create a `brainparc` object, which internally is a named list holding the surfaces (the left and right hemisphere meshes) and the surface parcellations (according to some brain atlas) for these meshes. The parcellations assign to each vertex of a mesh a single region.

One can construct a brainparc manually from arbitrary loaded meshes and parcellations using the `brainparc` function, but here we use the function `brainparc_fs`, which is more convenient if you want to read it from files in a `SUBJECTS_DIR` of `recon-all` output data. We create a brainparc for the `fsaverage` template:


```{r, eval = TRUE}
library("brainloc");
sjd = brainloc::get_subjects_dir(); # Searches for FreeSurfer SUBJECTS_DIR on machine.
bp = brainparc_fs(sjd, "fsaverage", surface = "white", atlas = "aparc");
```


### Finding the vertex closest to a query coordinate

Let's say we have some query coordinates in surface space and want to find the closest vertex in the `brainparc` for each of the coordinates. Here is how we can do that:

```{r, eval = TRUE}
query_coords = matrix(seq(9)+0.1, ncol = 3, byrow = TRUE);
query_coords

ccv = coord_closest_vertex(query_coords, get_surface(bp));
ccv
```

This assumes that the query coordinates are in the surfaces space and uses Euclidean distance. It works for all subjects and meshes.

### Finding the MNI152 and Talairach coordinates for a point or vertex in MNI305 space

This assumes that you query vertex (or coordinate) is in MNI305 space. This is true for all FreeSurfer standard template subjects, like `fsaverage`, `fsaverage6`, etc. Our `brainparc` is for `fsaverage`, so we can use the coordinates of its vertices to query.

```{r, eval = TRUE}
query_vertices = c(10L, 145029L);
query_hemis = c("lh", "rh");
query_coords = get_surface_coords(bp, query_vertices, query_hemis);
query_coords

coord_info = coord_MNI305_info(query_coords, surface = get_surface(bp));
coord_info
```

Note: If you have the `regfusionr` package installed, have a look at the `method` parameter of the `coord_MNI305_info` function: you can use the more accurate `regfusionr` method to transform from MNI305 to MNI152 then. By default, the linear 4x4 matrix from the coordinate systems documentation page of FreeSurfer is used for the transformation.


